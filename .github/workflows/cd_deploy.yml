name: Deploy to Kubernetes
on:
push:
branches:
- main


permissions:
contents: read


jobs:
deploy:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4


- name: Decode kubeconfig
env:
KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
run: |
echo "$KUBE_CONFIG" | base64 --decode > kubeconfig
mkdir -p $HOME/.kube
mv kubeconfig $HOME/.kube/config


- name: Set up kubectl
uses: azure/setup-kubectl@v3
with:
version: 'latest'


- name: Pull image and update deployment
run: |
IMAGE=ghcr.io/${{ secrets.GHCR_USERNAME }}/federated-ml:latest
kubectl set image deployment/federated-ml federated-ml=$IMAGE --record || true


- name: Wait for rollout
run: kubectl rollout status deployment/federated-ml --timeout=120s